# Docker Registry ä»£ç†æœåŠ¡ - å¿«é€Ÿå¼€å§‹

## ğŸ“‹ é¡¹ç›®è¯´æ˜

è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Docker Hub é•œåƒä»£ç†æœåŠ¡ï¼Œç‰¹ç‚¹ï¼š

- âœ… **è½»é‡åŒ–**: ä»…ä½¿ç”¨ Nginx + Registry:2ï¼Œä¸è½¬å­˜é•œåƒ
- âœ… **å®‰å…¨**: éœ€è¦ç™»å½•è®¤è¯ï¼Œé˜²æ­¢æ»¥ç”¨
- âœ… **é˜²æŠ¤**: Nginx rate limiting é™æµä¿æŠ¤
- âœ… **è‡ªåŠ¨ HTTPS**: é›†æˆ Traefik è‡ªåŠ¨è¯ä¹¦
- âœ… **å®æ—¶ä»£ç†**: æŒ‰éœ€è½¬å‘ï¼Œæ— éœ€é¢„å…ˆåŒæ­¥

## ğŸš€ 5 åˆ†é’Ÿéƒ¨ç½²

### æ­¥éª¤ 1: åˆå§‹åŒ–ï¼ˆç”Ÿæˆç”¨æˆ·è®¤è¯ï¼‰

```bash
cd /Users/baidu/CascadeProjects/docker-registry-proxy
./setup.sh
```

æŒ‰æç¤ºè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼ˆç”¨äº `docker login`ï¼‰ã€‚

### æ­¥éª¤ 2: ä¿®æ”¹é…ç½®

æ‰“å¼€ `docker-compose.yml`ï¼Œæœç´¢ `TODO`ï¼Œä¿®æ”¹ 4 å¤„é…ç½®ï¼š

```yaml
# 1. ä¿®æ”¹åŸŸåï¼ˆå¿…æ”¹ï¼‰
- "traefik.http.routers.docker-proxy.rule=Host(`docker-proxy.yourdomain.com`)"
  # æ”¹ä¸ºæ‚¨çš„å®é™…åŸŸå

# 2. ç¡®è®¤ Traefik HTTPS å…¥å£åç§°ï¼ˆé€šå¸¸æ˜¯ websecureï¼‰
- "traefik.http.routers.docker-proxy.entrypoints=websecure"

# 3. ç¡®è®¤ Traefik è¯ä¹¦è§£æå™¨åç§°ï¼ˆé€šå¸¸æ˜¯ letsencryptï¼‰
- "traefik.http.routers.docker-proxy.tls.certresolver=letsencrypt"

# 4. ç¡®è®¤ Traefik ç½‘ç»œåç§°ï¼ˆæ‚¨æä¾›çš„æ˜¯ traefik-netï¼‰
networks:
  traefik-net:
    external: true
```

**å¦‚ä½•æŸ¥æ‰¾ Traefik é…ç½®ï¼Ÿ**

æŸ¥çœ‹æ‚¨ç°æœ‰çš„ Traefik æœåŠ¡é…ç½®ï¼Œæˆ–æ‰§è¡Œï¼š

```bash
# æŸ¥çœ‹ Traefik å®¹å™¨é…ç½®
docker inspect <traefikå®¹å™¨å> | grep -E "certresolver|entrypoint"
```

### æ­¥éª¤ 3: ç¡®ä¿ Traefik ç½‘ç»œå­˜åœ¨

```bash
docker network create traefik-net
```

å¦‚æœæç¤ºå·²å­˜åœ¨ï¼Œå¿½ç•¥å³å¯ã€‚

### æ­¥éª¤ 4: å¯åŠ¨æœåŠ¡

```bash
docker-compose up -d
```

æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸï¼š

```bash
docker-compose logs -f
```

çœ‹åˆ°ç±»ä¼¼è¾“å‡ºè¡¨ç¤ºæˆåŠŸï¼š
```
registry_1  | level=info msg="listening on [::]:5000"
nginx_1     | ... "GET /v2/ HTTP/1.1" 401 ...
```

### æ­¥éª¤ 5: æµ‹è¯•

#### æœ¬åœ°æµ‹è¯•

```bash
./test.sh
```

#### å®¢æˆ·ç«¯æµ‹è¯•

åœ¨ä»»æ„æœºå™¨ä¸Šæ‰§è¡Œï¼š

```bash
# ç™»å½•ä»£ç†æœåŠ¡å™¨
docker login docker-proxy.yourdomain.com
# è¾“å…¥æ­¥éª¤ 1 ä¸­åˆ›å»ºçš„ç”¨æˆ·åå’Œå¯†ç 

# æ‹‰å–æµ‹è¯•é•œåƒ
docker pull docker-proxy.yourdomain.com/library/alpine:latest

# éªŒè¯
docker images | grep alpine
```

## âœ… å®Œæˆï¼

æ‚¨çš„ Docker Registry ä»£ç†æœåŠ¡å·²æˆåŠŸéƒ¨ç½²ã€‚

---

## ğŸ“š å¸¸ç”¨å‘½ä»¤

### ä½¿ç”¨ Makefileï¼ˆæ¨èï¼‰

```bash
make help          # æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
make start         # å¯åŠ¨æœåŠ¡
make stop          # åœæ­¢æœåŠ¡
make restart       # é‡å¯æœåŠ¡
make logs          # æŸ¥çœ‹æ—¥å¿—
make status        # æŸ¥çœ‹çŠ¶æ€
make test          # è¿è¡Œæµ‹è¯•
make add-user      # æ·»åŠ ç”¨æˆ·
make list-users    # åˆ—å‡ºç”¨æˆ·
make backup        # å¤‡ä»½é…ç½®
```

### ç”¨æˆ·ç®¡ç†

```bash
# æ·»åŠ æ–°ç”¨æˆ·
./manage-users.sh add <ç”¨æˆ·å>

# åˆ é™¤ç”¨æˆ·
./manage-users.sh delete <ç”¨æˆ·å>

# åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
./manage-users.sh list

# ä¿®æ”¹å¯†ç 
./manage-users.sh change <ç”¨æˆ·å>
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æ—¥å¿—
docker-compose logs -f

# ä»…æŸ¥çœ‹ Nginx
docker-compose logs -f nginx

# ä»…æŸ¥çœ‹ Registry
docker-compose logs -f registry

# æœ€è¿‘ 100 è¡Œ
docker-compose logs --tail=100
```

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### æ‹‰å–å®˜æ–¹é•œåƒ

```bash
# å®˜æ–¹é•œåƒéœ€è¦åŠ  library/ å‰ç¼€
docker pull docker-proxy.yourdomain.com/library/nginx:alpine
docker pull docker-proxy.yourdomain.com/library/redis:latest
docker pull docker-proxy.yourdomain.com/library/postgres:15
```

### æ‹‰å–ç¬¬ä¸‰æ–¹é•œåƒ

```bash
# ç¬¬ä¸‰æ–¹é•œåƒç›´æ¥ä½¿ç”¨ç»„ç»‡å
docker pull docker-proxy.yourdomain.com/bitnami/nginx:latest
docker pull docker-proxy.yourdomain.com/grafana/grafana:latest
```

### åœ¨ Docker Compose ä¸­ä½¿ç”¨

```yaml
version: '3.8'

services:
  web:
    # ä½¿ç”¨ä»£ç†æ‹‰å–é•œåƒ
    image: docker-proxy.yourdomain.com/library/nginx:alpine
    ports:
      - "80:80"
```

---

## â“ å¸¸è§é—®é¢˜

### 1. æ— æ³•ç™»å½•

**ç—‡çŠ¶**: `docker login` æç¤º `unauthorized`

**è§£å†³**:
```bash
# æ£€æŸ¥è®¤è¯æ–‡ä»¶
ls -l auth/htpasswd

# é‡æ–°ç”Ÿæˆ
./setup.sh
docker-compose restart
```

### 2. æ— æ³•æ‹‰å–é•œåƒ

**ç—‡çŠ¶**: `docker pull` å¤±è´¥

**è§£å†³**:
```bash
# ç¡®è®¤å·²ç™»å½•
docker login docker-proxy.yourdomain.com

# æ£€æŸ¥é•œåƒåç§°æ ¼å¼ï¼ˆå®˜æ–¹é•œåƒéœ€è¦ library/ å‰ç¼€ï¼‰
# æ­£ç¡®: docker-proxy.yourdomain.com/library/nginx
# é”™è¯¯: docker-proxy.yourdomain.com/nginx

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### 3. HTTPS è¯ä¹¦é”™è¯¯

**ç—‡çŠ¶**: æç¤ºè¯ä¹¦æ— æ•ˆ

**è§£å†³**:
```bash
# ç¡®è®¤åŸŸå DNS å·²è§£æ
nslookup docker-proxy.yourdomain.com

# æ£€æŸ¥ Traefik æ—¥å¿—
docker logs <traefikå®¹å™¨å> | grep -i certificate

# ç­‰å¾…å‡ åˆ†é’Ÿè®© Traefik ç”³è¯·è¯ä¹¦
docker-compose restart nginx
```

### 4. é™æµè§¦å‘ï¼ˆ503 é”™è¯¯ï¼‰

**ç—‡çŠ¶**: `503 Service Temporarily Unavailable`

**è§£å†³**:

ç¼–è¾‘ `config/nginx.conf`ï¼Œè°ƒæ•´é™æµå‚æ•°ï¼š

```nginx
# ä¿®æ”¹è¿™ä¸¤è¡Œ
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=50r/s;
limit_req zone=registry_limit burst=100 nodelay;
```

ç„¶åé‡å¯ï¼š
```bash
docker-compose restart nginx
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **å®šæœŸæ›´æ–°å¯†ç **
   ```bash
   ./manage-users.sh change <ç”¨æˆ·å>
   ```

2. **ç›‘æ§è®¿é—®æ—¥å¿—**
   ```bash
   docker exec -it docker-registry-nginx tail -f /var/log/nginx/access.log
   ```

3. **é™åˆ¶è®¿é—® IP**ï¼ˆå¯é€‰ï¼‰
   
   ç¼–è¾‘ `config/nginx.conf`ï¼Œåœ¨ `location /v2/` ä¸­æ·»åŠ ï¼š
   ```nginx
   allow 192.168.1.0/24;  # å…è®¸å†…ç½‘
   deny all;              # æ‹’ç»å…¶ä»–
   ```

4. **å®šæœŸå¤‡ä»½**
   ```bash
   make backup
   # æˆ–
   tar -czf backup.tar.gz config/ auth/
   ```

---

## ğŸ“– æ›´å¤šæ–‡æ¡£

- [README.md](README.md) - å®Œæ•´æ–‡æ¡£
- [QUICKSTART.md](QUICKSTART.md) - è‹±æ–‡å¿«é€Ÿå¼€å§‹
- [STRUCTURE.md](STRUCTURE.md) - é¡¹ç›®ç»“æ„è¯´æ˜

---

## ğŸ¯ è°ƒæ•´é™æµå‚æ•°

æ ¹æ®ä½¿ç”¨è§„æ¨¡è°ƒæ•´ `config/nginx.conf`:

```nginx
# ä¸ªäººä½¿ç”¨ï¼ˆé»˜è®¤ï¼‰
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=10r/s;
limit_req zone=registry_limit burst=20 nodelay;

# å°å›¢é˜Ÿï¼ˆ5-10 äººï¼‰
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=20r/s;
limit_req zone=registry_limit burst=50 nodelay;

# ä¸­ç­‰è§„æ¨¡ï¼ˆ10-50 äººï¼‰
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=50r/s;
limit_req zone=registry_limit burst=100 nodelay;
```

ä¿®æ”¹åé‡å¯ï¼š
```bash
docker-compose restart nginx
```

---

## ğŸ—‘ï¸ å¸è½½

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# åˆ é™¤æ•°æ®å·
docker volume rm docker-registry-proxy_registry-data
docker volume rm docker-registry-proxy_nginx-logs

# åˆ é™¤é¡¹ç›®ç›®å½•
cd ..
rm -rf docker-registry-proxy
```

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹ [README.md](README.md) è·å–è¯¦ç»†æ–‡æ¡£ã€‚
