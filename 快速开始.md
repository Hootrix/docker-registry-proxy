# Docker Registry 代理服务 - 快速开始

## 📋 项目说明

这是一个轻量级的 Docker Hub 镜像代理服务，特点：

- ✅ **轻量化**: 仅使用 Nginx + Registry:2，不转存镜像
- ✅ **安全**: 需要登录认证，防止滥用
- ✅ **防护**: Nginx rate limiting 限流保护
- ✅ **自动 HTTPS**: 集成 Traefik 自动证书
- ✅ **实时代理**: 按需转发，无需预先同步

## 🚀 5 分钟部署

### 步骤 1: 初始化（生成用户认证）

```bash
cd /Users/baidu/CascadeProjects/docker-registry-proxy
./setup.sh
```

按提示输入用户名和密码（用于 `docker login`）。

### 步骤 2: 修改配置

打开 `docker-compose.yml`，搜索 `TODO`，修改 4 处配置：

```yaml
# 1. 修改域名（必改）
- "traefik.http.routers.docker-proxy.rule=Host(`docker-proxy.yourdomain.com`)"
  # 改为您的实际域名

# 2. 确认 Traefik HTTPS 入口名称（通常是 websecure）
- "traefik.http.routers.docker-proxy.entrypoints=websecure"

# 3. 确认 Traefik 证书解析器名称（通常是 letsencrypt）
- "traefik.http.routers.docker-proxy.tls.certresolver=letsencrypt"

# 4. 确认 Traefik 网络名称（您提供的是 traefik-net）
networks:
  traefik-net:
    external: true
```

**如何查找 Traefik 配置？**

查看您现有的 Traefik 服务配置，或执行：

```bash
# 查看 Traefik 容器配置
docker inspect <traefik容器名> | grep -E "certresolver|entrypoint"
```

### 步骤 3: 确保 Traefik 网络存在

```bash
docker network create traefik-net
```

如果提示已存在，忽略即可。

### 步骤 4: 启动服务

```bash
docker-compose up -d
```

查看日志确认启动成功：

```bash
docker-compose logs -f
```

看到类似输出表示成功：
```
registry_1  | level=info msg="listening on [::]:5000"
nginx_1     | ... "GET /v2/ HTTP/1.1" 401 ...
```

### 步骤 5: 测试

#### 本地测试

```bash
./test.sh
```

#### 客户端测试

在任意机器上执行：

```bash
# 登录代理服务器
docker login docker-proxy.yourdomain.com
# 输入步骤 1 中创建的用户名和密码

# 拉取测试镜像
docker pull docker-proxy.yourdomain.com/library/alpine:latest

# 验证
docker images | grep alpine
```

## ✅ 完成！

您的 Docker Registry 代理服务已成功部署。

---

## 📚 常用命令

### 使用 Makefile（推荐）

```bash
make help          # 查看所有命令
make start         # 启动服务
make stop          # 停止服务
make restart       # 重启服务
make logs          # 查看日志
make status        # 查看状态
make test          # 运行测试
make add-user      # 添加用户
make list-users    # 列出用户
make backup        # 备份配置
```

### 用户管理

```bash
# 添加新用户
./manage-users.sh add <用户名>

# 删除用户
./manage-users.sh delete <用户名>

# 列出所有用户
./manage-users.sh list

# 修改密码
./manage-users.sh change <用户名>
```

### 查看日志

```bash
# 实时日志
docker-compose logs -f

# 仅查看 Nginx
docker-compose logs -f nginx

# 仅查看 Registry
docker-compose logs -f registry

# 最近 100 行
docker-compose logs --tail=100
```

---

## 🔧 使用示例

### 拉取官方镜像

```bash
# 官方镜像需要加 library/ 前缀
docker pull docker-proxy.yourdomain.com/library/nginx:alpine
docker pull docker-proxy.yourdomain.com/library/redis:latest
docker pull docker-proxy.yourdomain.com/library/postgres:15
```

### 拉取第三方镜像

```bash
# 第三方镜像直接使用组织名
docker pull docker-proxy.yourdomain.com/bitnami/nginx:latest
docker pull docker-proxy.yourdomain.com/grafana/grafana:latest
```

### 在 Docker Compose 中使用

```yaml
version: '3.8'

services:
  web:
    # 使用代理拉取镜像
    image: docker-proxy.yourdomain.com/library/nginx:alpine
    ports:
      - "80:80"
```

---

## ❓ 常见问题

### 1. 无法登录

**症状**: `docker login` 提示 `unauthorized`

**解决**:
```bash
# 检查认证文件
ls -l auth/htpasswd

# 重新生成
./setup.sh
docker-compose restart
```

### 2. 无法拉取镜像

**症状**: `docker pull` 失败

**解决**:
```bash
# 确认已登录
docker login docker-proxy.yourdomain.com

# 检查镜像名称格式（官方镜像需要 library/ 前缀）
# 正确: docker-proxy.yourdomain.com/library/nginx
# 错误: docker-proxy.yourdomain.com/nginx

# 查看日志
docker-compose logs -f
```

### 3. HTTPS 证书错误

**症状**: 提示证书无效

**解决**:
```bash
# 确认域名 DNS 已解析
nslookup docker-proxy.yourdomain.com

# 检查 Traefik 日志
docker logs <traefik容器名> | grep -i certificate

# 等待几分钟让 Traefik 申请证书
docker-compose restart nginx
```

### 4. 限流触发（503 错误）

**症状**: `503 Service Temporarily Unavailable`

**解决**:

编辑 `config/nginx.conf`，调整限流参数：

```nginx
# 修改这两行
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=50r/s;
limit_req zone=registry_limit burst=100 nodelay;
```

然后重启：
```bash
docker-compose restart nginx
```

---

## 🔒 安全建议

1. **定期更新密码**
   ```bash
   ./manage-users.sh change <用户名>
   ```

2. **监控访问日志**
   ```bash
   docker exec -it docker-registry-nginx tail -f /var/log/nginx/access.log
   ```

3. **限制访问 IP**（可选）
   
   编辑 `config/nginx.conf`，在 `location /v2/` 中添加：
   ```nginx
   allow 192.168.1.0/24;  # 允许内网
   deny all;              # 拒绝其他
   ```

4. **定期备份**
   ```bash
   make backup
   # 或
   tar -czf backup.tar.gz config/ auth/
   ```

---

## 📖 更多文档

- [README.md](README.md) - 完整文档
- [QUICKSTART.md](QUICKSTART.md) - 英文快速开始
- [STRUCTURE.md](STRUCTURE.md) - 项目结构说明

---

## 🎯 调整限流参数

根据使用规模调整 `config/nginx.conf`:

```nginx
# 个人使用（默认）
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=10r/s;
limit_req zone=registry_limit burst=20 nodelay;

# 小团队（5-10 人）
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=20r/s;
limit_req zone=registry_limit burst=50 nodelay;

# 中等规模（10-50 人）
limit_req_zone $binary_remote_addr zone=registry_limit:10m rate=50r/s;
limit_req zone=registry_limit burst=100 nodelay;
```

修改后重启：
```bash
docker-compose restart nginx
```

---

## 🗑️ 卸载

```bash
# 停止并删除容器
docker-compose down

# 删除数据卷
docker volume rm docker-registry-proxy_registry-data
docker volume rm docker-registry-proxy_nginx-logs

# 删除项目目录
cd ..
rm -rf docker-registry-proxy
```

---

**需要帮助？** 查看 [README.md](README.md) 获取详细文档。
